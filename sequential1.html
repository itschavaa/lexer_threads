<!DOCTYPE html> <html> <head><link rel='stylesheet' href='./colors.css' type='text/css' /></head><body><style>
body{
background-color:#000000;
}
.string{
color: #f44f4f;
}
.float{
color: #c37ed5;
}
.operator{
color: #fafa8a;
font-weight: 900;
}
.variable{
color: #46f6b0;
}
.delimiter{
color: #3dd1f3;
}
.comment{
color: #63ff01;
}
.undefinded{
color: #dec7c7;
}
.reserved{
color: #7d42b0;
}
.int{
color: #a6ffeb;
}
</style><span class= comment>// =================================================================</span><br><span class= comment>//</span><br><span class= comment>// File: example01.cpp</span><br><span class= comment>// Author: Pedro Perez</span><br><span class= comment>// Description: This file contains the code that adds all the</span><br><span class= comment>//				elements of an integer array using one thread and</span><br><span class= comment>//				multiple threads. Also, it calculates the SpeedUp.</span><br><span class= comment>//</span><br><span class= comment>//        To compile: g++ example01.cpp -lpthread</span><br><span class= comment>//</span><br><span class= comment>// Copyright (c) 2023 by Tecnologico de Monterrey.</span><br><span class= comment>// All Rights Reserved. May be reproduced for any non-commercial</span><br><span class= comment>// purpose.</span><br><span class= comment>//</span><br><span class= comment>// =================================================================</span><br><br><span class= delimiter>#</span><span class= variable>include</span><span class= space> </span><span class= delimiter><</span><span class= variable>iostream</span><span class= delimiter>></span><br><span class= delimiter>#</span><span class= variable>include</span><span class= space> </span><span class= delimiter><</span><span class= variable>iomanip</span><span class= delimiter>></span><br><span class= delimiter>#</span><span class= variable>include</span><span class= space> </span><span class= delimiter><</span><span class= variable>pthread</span><span class= delimiter>.</span><span class= variable>h</span><span class= delimiter>></span><br><span class= delimiter>#</span><span class= variable>include</span><span class= space> </span><span class= delimiter><</span><span class= variable>chrono</span><span class= delimiter>></span><br><span class= delimiter>#</span><span class= variable>include</span><span class= space> </span><span class= string>"utils.h"</span><br><br><span class= reserved>using</span><span class= space> </span><span class= reserved>namespace</span><span class= space> </span><span class= variable>std</span><span class= delimiter>;</span><br><span class= reserved>using</span><span class= space> </span><span class= reserved>namespace</span><span class= space> </span><span class= variable>std</span><span class= variable>chrono</span><span class= delimiter>;</span><br><br><span class= reserved>const</span><span class= space> </span><span class= reserved>int</span><span class= space> </span><span class= variable>CELLS</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= int>1000000000</span><span class= delimiter>;</span><span class= space> </span><span class= comment>//1e9</span><br><span class= reserved>const</span><span class= space> </span><span class= reserved>int</span><span class= space> </span><span class= variable>THREADS</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= int>8</span><span class= delimiter>;</span><br><br><span class= comment>// ====================== ONE THREAD IMPLEMENTATION ======================</span><br><span class= reserved>double</span><span class= space> </span><span class= variable>sumArray</span><span class= delimiter>(</span><span class= reserved>int</span><span class= space> </span><span class= operator>*</span><span class= variable>arr</span><span class= delimiter>,</span><span class= space> </span><span class= reserved>int</span><span class= space> </span><span class= variable>size</span><span class= delimiter>)</span><span class= space> </span><span class= delimiter>{</span><br><span class= space>    </span><span class= reserved>double</span><span class= space> </span><span class= variable>acum</span><span class= delimiter>;</span><br><br><span class= space>    </span><span class= variable>acum</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= int>0</span><span class= delimiter>;</span><br><span class= space>    </span><span class= reserved>for</span><span class= space> </span><span class= delimiter>(</span><span class= reserved>int</span><span class= space> </span><span class= variable>i</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= int>0</span><span class= delimiter>;</span><span class= space> </span><span class= variable>i</span><span class= delimiter><</span><span class= space> </span><span class= variable>size</span><span class= delimiter>;</span><span class= space> </span><span class= variable>i</span><span class= operator>+</span><span class= operator>+</span><span class= delimiter>)</span><span class= space> </span><span class= delimiter>{</span><br><span class= space>        </span><span class= variable>acum</span><span class= space> </span><span class= operator>+</span><span class= operator>=</span><span class= space> </span><span class= variable>arr</span><span class= delimiter>[</span><span class= variable>i</span><span class= delimiter>]</span><span class= delimiter>;</span><br><span class= space>    </span><span class= delimiter>}</span><br><span class= space>    </span><span class= reserved>return</span><span class= space> </span><span class= variable>acum</span><span class= delimiter>;</span><br><span class= delimiter>}</span><br><span class= comment>// ====================== ONE THREAD IMPLEMENTATION ======================</span><br><br><br><span class= comment>// ===================== MULTITHREAD IMPLEMENTATION ======================</span><br><span class= reserved>typedef</span><span class= space> </span><span class= reserved>struct</span><span class= space> </span><span class= delimiter>{</span><br><span class= space>    </span><span class= reserved>int</span><span class= space> </span><span class= variable>start</span><span class= delimiter>,</span><span class= space> </span><span class= variable>end</span><span class= delimiter>;</span><span class= space> </span><span class= comment>// [start, end)</span><br><span class= space>    </span><span class= reserved>int</span><span class= space> </span><span class= operator>*</span><span class= variable>arr</span><span class= delimiter>;</span><br><span class= space>    </span><span class= reserved>double</span><span class= space> </span><span class= variable>result</span><span class= delimiter>;</span><br><span class= delimiter>}</span><span class= space> </span><span class= variable>Block</span><span class= delimiter>;</span><br><br><span class= reserved>void</span><span class= operator>*</span><span class= space> </span><span class= variable>task</span><span class= delimiter>(</span><span class= reserved>void</span><span class= operator>*</span><span class= space> </span><span class= variable>param</span><span class= delimiter>)</span><span class= space> </span><span class= delimiter>{</span><br><span class= space>    </span><span class= reserved>double</span><span class= space> </span><span class= variable>acum</span><span class= delimiter>;</span><br><span class= space>    </span><span class= variable>Block</span><span class= space> </span><span class= operator>*</span><span class= variable>block</span><span class= delimiter>;</span><br><br><span class= space>    </span><span class= variable>block</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= delimiter>(</span><span class= variable>Block</span><span class= space> </span><span class= operator>*</span><span class= delimiter>)</span><span class= space> </span><span class= variable>param</span><span class= delimiter>;</span><br><span class= space>    </span><span class= variable>acum</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= int>0</span><span class= delimiter>;</span><br><span class= space>    </span><span class= reserved>for</span><span class= space> </span><span class= delimiter>(</span><span class= reserved>int</span><span class= space> </span><span class= variable>i</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= variable>block</span><span class= operator>-</span><span class= delimiter>></span><span class= variable>start</span><span class= delimiter>;</span><span class= space> </span><span class= variable>i</span><span class= space> </span><span class= delimiter><</span><span class= space> </span><span class= variable>block</span><span class= operator>-</span><span class= delimiter>></span><span class= variable>end</span><span class= delimiter>;</span><span class= space> </span><span class= variable>i</span><span class= operator>+</span><span class= operator>+</span><span class= delimiter>)</span><span class= space> </span><span class= delimiter>{</span><br><span class= space>        </span><span class= variable>acum</span><span class= space> </span><span class= operator>+</span><span class= operator>=</span><span class= space> </span><span class= variable>block</span><span class= operator>-</span><span class= delimiter>></span><span class= variable>arr</span><span class= delimiter>[</span><span class= variable>i</span><span class= delimiter>]</span><span class= delimiter>;</span><br><span class= space>    </span><span class= delimiter>}</span><br><span class= space>    </span><span class= variable>block</span><span class= operator>-</span><span class= delimiter>></span><span class= variable>result</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= variable>acum</span><span class= delimiter>;</span><br><span class= space>    </span><span class= variable>pthread_exit</span><span class= delimiter>(</span><span class= int>0</span><span class= delimiter>)</span><span class= delimiter>;</span><br><span class= delimiter>}</span><br><span class= comment>// ===================== MULTITHREAD IMPLEMENTATION ======================</span><br><br><span class= reserved>int</span><span class= space> </span><span class= variable>main</span><span class= delimiter>(</span><span class= reserved>int</span><span class= space> </span><span class= variable>argc</span><span class= delimiter>,</span><span class= space> </span><span class= reserved>char</span><span class= operator>*</span><span class= space> </span><span class= variable>argv</span><span class= delimiter>[</span><span class= delimiter>]</span><span class= delimiter>)</span><span class= space> </span><span class= delimiter>{</span><br><span class= space>    </span><span class= reserved>int</span><span class= space> </span><span class= operator>*</span><span class= variable>arr</span><span class= delimiter>;</span><br><span class= space>    </span><span class= reserved>double</span><span class= space> </span><span class= variable>result</span><span class= delimiter>;</span><br><br><span class= space>    </span><span class= comment>// These variables are used to keep track of the execution time.</span><br><span class= space>    </span><span class= variable>high_resolution_clock</span><span class= variable>time_point</span><span class= space> </span><span class= variable>start</span><span class= delimiter>,</span><span class= space> </span><span class= variable>end</span><span class= delimiter>;</span><br><span class= space>    </span><span class= reserved>double</span><span class= space> </span><span class= variable>oneThread</span><span class= delimiter>,</span><span class= space> </span><span class= variable>multiThread</span><span class= delimiter>;</span><br><br><span class= space>    </span><span class= comment>// These variables are used by thread management.</span><br><span class= space>    </span><span class= reserved>int</span><span class= space> </span><span class= variable>blockSize</span><span class= delimiter>;</span><br><span class= space>    </span><span class= variable>Block</span><span class= space> </span><span class= variable>blocks</span><span class= delimiter>[</span><span class= variable>THREADS</span><span class= delimiter>]</span><span class= delimiter>;</span><br><span class= space>    </span><span class= variable>pthread_t</span><span class= space> </span><span class= variable>tids</span><span class= delimiter>[</span><span class= variable>THREADS</span><span class= delimiter>]</span><span class= delimiter>;</span><br><br><span class= space>    </span><span class= variable>arr</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= reserved>new</span><span class= space> </span><span class= reserved>int</span><span class= delimiter>[</span><span class= variable>CELLS</span><span class= delimiter>]</span><span class= delimiter>;</span><br><span class= space>    </span><span class= variable>fill_array</span><span class= delimiter>(</span><span class= variable>arr</span><span class= delimiter>,</span><span class= space> </span><span class= variable>CELLS</span><span class= delimiter>)</span><span class= delimiter>;</span><br><span class= space>    </span><span class= variable>display_array</span><span class= delimiter>(</span><span class= string>"arr:"</span><span class= delimiter>,</span><span class= space> </span><span class= variable>arr</span><span class= delimiter>)</span><span class= delimiter>;</span><br><br><span class= space>    </span><span class= comment>// ======================= ONE THREAD EXECUTION ========================</span><br><span class= space>    </span><span class= variable>oneThread</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= int>0</span><span class= delimiter>;</span><br><span class= space>    </span><span class= variable>cout</span><span class= space> </span><span class= delimiter><</span><span class= delimiter><</span><span class= space> </span><span class= string>"Starting one thread...\n"</span><span class= delimiter>;</span><br><span class= space>    </span><span class= reserved>for</span><span class= space> </span><span class= delimiter>(</span><span class= reserved>int</span><span class= space> </span><span class= variable>j</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= int>0</span><span class= delimiter>;</span><span class= space> </span><span class= variable>j</span><span class= space> </span><span class= delimiter><</span><span class= space> </span><span class= variable>N</span><span class= delimiter>;</span><span class= space> </span><span class= variable>j</span><span class= operator>+</span><span class= operator>+</span><span class= delimiter>)</span><span class= space> </span><span class= delimiter>{</span><br><span class= space>        </span><span class= variable>start</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= variable>high_resolution_clock</span><span class= variable>now</span><span class= delimiter>(</span><span class= delimiter>)</span><span class= delimiter>;</span><br><span class= space>        </span><span class= variable>result</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= variable>sumArray</span><span class= delimiter>(</span><span class= variable>arr</span><span class= delimiter>,</span><span class= space> </span><span class= variable>CELLS</span><span class= delimiter>)</span><span class= delimiter>;</span><br><span class= space>        </span><span class= variable>end</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= variable>high_resolution_clock</span><span class= variable>now</span><span class= delimiter>(</span><span class= delimiter>)</span><span class= delimiter>;</span><br><span class= space>        </span><span class= variable>oneThread</span><span class= space> </span><span class= operator>+</span><span class= operator>=</span><span class= space> </span><span class= variable>duration</span><span class= delimiter><</span><span class= reserved>double</span><span class= delimiter>,</span><span class= space> </span><span class= variable>std</span><span class= variable>milli</span><span class= delimiter>></span><span class= delimiter>(</span><span class= variable>end</span><span class= space> </span><span class= operator>-</span><span class= space> </span><span class= variable>start</span><span class= delimiter>)</span><span class= delimiter>.</span><span class= variable>count</span><span class= delimiter>(</span><span class= delimiter>)</span><span class= delimiter>;</span><br><span class= space>    </span><span class= delimiter>}</span><br><span class= space>    </span><span class= variable>oneThread</span><span class= space> </span><span class= operator>/</span><span class= operator>=</span><span class= space> </span><span class= variable>N</span><span class= delimiter>;</span><br><span class= space>    </span><span class= variable>cout</span><span class= space> </span><span class= delimiter><</span><span class= delimiter><</span><span class= space> </span><span class= string>"result one thread = " << fixed << setprecision(0) << result << "\n"</span><span class= delimiter>;</span><br><span class= space>    </span><span class= variable>cout</span><span class= space> </span><span class= delimiter><</span><span class= delimiter><</span><span class= space> </span><span class= string>"one thread avg time =  " << fixed << setprecision(6) << oneThread << " ms\n"</span><span class= delimiter>;</span><br><span class= space>    </span><span class= comment>// ======================= ONE THREAD EXECUTION ========================</span><br><br><span class= space>    </span><span class= comment>// ======================= MULTITHREAD EXECUTION ========================</span><br><span class= space>    </span><span class= variable>blockSize</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= variable>CELLS</span><span class= space> </span><span class= operator>/</span><span class= space> </span><span class= variable>THREADS</span><span class= delimiter>;</span><br><span class= space>    </span><span class= reserved>for</span><span class= space> </span><span class= delimiter>(</span><span class= reserved>int</span><span class= space> </span><span class= variable>i</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= int>0</span><span class= delimiter>;</span><span class= space> </span><span class= variable>i</span><span class= space> </span><span class= delimiter><</span><span class= space> </span><span class= variable>THREADS</span><span class= delimiter>;</span><span class= space> </span><span class= variable>i</span><span class= operator>+</span><span class= operator>+</span><span class= delimiter>)</span><span class= space> </span><span class= delimiter>{</span><br><span class= space>        </span><span class= variable>blocks</span><span class= delimiter>[</span><span class= variable>i</span><span class= delimiter>]</span><span class= delimiter>.</span><span class= variable>start</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= variable>i</span><span class= space> </span><span class= operator>*</span><span class= space> </span><span class= variable>blockSize</span><span class= delimiter>;</span><br><span class= space>        </span><span class= variable>blocks</span><span class= delimiter>[</span><span class= variable>i</span><span class= delimiter>]</span><span class= delimiter>.</span><span class= variable>end</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= delimiter>(</span><span class= variable>i</span><span class= space> </span><span class= delimiter>!</span><span class= operator>=</span><span class= space> </span><span class= delimiter>(</span><span class= variable>THREADS</span><span class= space> </span><span class= operator>-</span><span class= space> </span><span class= int>1</span><span class= delimiter>)</span><span class= delimiter>)</span><span class= space> </span><span class= delimiter>(</span><span class= variable>i</span><span class= space> </span><span class= operator>+</span><span class= space> </span><span class= int>1</span><span class= delimiter>)</span><span class= space> </span><span class= operator>*</span><span class= space> </span><span class= variable>blockSize</span><span class= space> </span><span class= space> </span><span class= variable>CELLS</span><span class= delimiter>;</span><br><span class= space>        </span><span class= variable>blocks</span><span class= delimiter>[</span><span class= variable>i</span><span class= delimiter>]</span><span class= delimiter>.</span><span class= variable>arr</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= variable>arr</span><span class= delimiter>;</span><br><span class= space>        </span><span class= variable>blocks</span><span class= delimiter>[</span><span class= variable>i</span><span class= delimiter>]</span><span class= delimiter>.</span><span class= variable>result</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= int>0</span><span class= delimiter>;</span><br><span class= space>    </span><span class= delimiter>}</span><br><br><span class= space>    </span><span class= variable>cout</span><span class= space> </span><span class= delimiter><</span><span class= delimiter><</span><span class= space> </span><span class= string>"Starting multithread...\n"</span><span class= delimiter>;</span><br><span class= space>    </span><span class= variable>multiThread</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= int>0</span><span class= delimiter>;</span><br><span class= space>    </span><span class= reserved>for</span><span class= space> </span><span class= delimiter>(</span><span class= reserved>int</span><span class= space> </span><span class= variable>j</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= int>0</span><span class= delimiter>;</span><span class= space> </span><span class= variable>j</span><span class= space> </span><span class= delimiter><</span><span class= space> </span><span class= variable>N</span><span class= delimiter>;</span><span class= space> </span><span class= variable>j</span><span class= operator>+</span><span class= operator>+</span><span class= delimiter>)</span><span class= space> </span><span class= delimiter>{</span><br><span class= space>        </span><span class= variable>start</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= variable>high_resolution_clock</span><span class= variable>now</span><span class= delimiter>(</span><span class= delimiter>)</span><span class= delimiter>;</span><br><br><span class= space>        </span><span class= reserved>for</span><span class= space> </span><span class= delimiter>(</span><span class= reserved>int</span><span class= space> </span><span class= variable>i</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= int>0</span><span class= delimiter>;</span><span class= space> </span><span class= variable>i</span><span class= space> </span><span class= delimiter><</span><span class= space> </span><span class= variable>THREADS</span><span class= delimiter>;</span><span class= space> </span><span class= variable>i</span><span class= operator>+</span><span class= operator>+</span><span class= delimiter>)</span><span class= space> </span><span class= delimiter>{</span><br><span class= space>            </span><span class= variable>pthread_create</span><span class= delimiter>(</span><span class= variable>tids</span><span class= delimiter>[</span><span class= variable>i</span><span class= delimiter>]</span><span class= delimiter>,</span><span class= space> </span><span class= variable>NULL</span><span class= delimiter>,</span><span class= space> </span><span class= variable>task</span><span class= delimiter>,</span><span class= space> </span><span class= delimiter>(</span><span class= reserved>void</span><span class= operator>*</span><span class= delimiter>)</span><span class= space> </span><span class= variable>blocks</span><span class= delimiter>[</span><span class= variable>i</span><span class= delimiter>]</span><span class= delimiter>)</span><span class= delimiter>;</span><br><span class= space>        </span><span class= delimiter>}</span><br><br><span class= space>        </span><span class= variable>result</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= int>0</span><span class= delimiter>;</span><br><span class= space>        </span><span class= reserved>for</span><span class= space> </span><span class= delimiter>(</span><span class= reserved>int</span><span class= space> </span><span class= variable>i</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= int>0</span><span class= delimiter>;</span><span class= space> </span><span class= variable>i</span><span class= space> </span><span class= delimiter><</span><span class= space> </span><span class= variable>THREADS</span><span class= delimiter>;</span><span class= space> </span><span class= variable>i</span><span class= operator>+</span><span class= operator>+</span><span class= delimiter>)</span><span class= space> </span><span class= delimiter>{</span><br><span class= space>            </span><span class= variable>pthread_join</span><span class= delimiter>(</span><span class= variable>tids</span><span class= delimiter>[</span><span class= variable>i</span><span class= delimiter>]</span><span class= delimiter>,</span><span class= space> </span><span class= variable>NULL</span><span class= delimiter>)</span><span class= delimiter>;</span><br><span class= space>            </span><span class= variable>result</span><span class= space> </span><span class= operator>+</span><span class= operator>=</span><span class= space> </span><span class= variable>blocks</span><span class= delimiter>[</span><span class= variable>i</span><span class= delimiter>]</span><span class= delimiter>.</span><span class= variable>result</span><span class= delimiter>;</span><br><span class= space>        </span><span class= delimiter>}</span><br><br><span class= space>        </span><span class= variable>end</span><span class= space> </span><span class= operator>=</span><span class= space> </span><span class= variable>high_resolution_clock</span><span class= variable>now</span><span class= delimiter>(</span><span class= delimiter>)</span><span class= delimiter>;</span><br><span class= space>        </span><span class= variable>multiThread</span><span class= space> </span><span class= operator>+</span><span class= operator>=</span><span class= space> </span><span class= variable>duration</span><span class= delimiter><</span><span class= reserved>double</span><span class= delimiter>,</span><span class= space> </span><span class= variable>std</span><span class= variable>milli</span><span class= delimiter>></span><span class= delimiter>(</span><span class= variable>end</span><span class= space> </span><span class= operator>-</span><span class= space> </span><span class= variable>start</span><span class= delimiter>)</span><span class= delimiter>.</span><span class= variable>count</span><span class= delimiter>(</span><span class= delimiter>)</span><span class= delimiter>;</span><br><span class= space>    </span><span class= delimiter>}</span><br><span class= space>    </span><span class= variable>multiThread</span><span class= space> </span><span class= operator>/</span><span class= operator>=</span><span class= space> </span><span class= variable>N</span><span class= delimiter>;</span><br><span class= space>    </span><span class= variable>cout</span><span class= space> </span><span class= delimiter><</span><span class= delimiter><</span><span class= space> </span><span class= string>"result multithread = " << fixed << setprecision(0) << result << "\n"</span><span class= delimiter>;</span><br><span class= space>    </span><span class= variable>cout</span><span class= space> </span><span class= delimiter><</span><span class= delimiter><</span><span class= space> </span><span class= string>"multithread avg time =  " << fixed << setprecision(6) << multiThread << " ms\n"</span><span class= delimiter>;</span><br><span class= space>    </span><span class= comment>// ======================= MULTITHREAD EXECUTION ========================</span><br><br><span class= space>    </span><span class= variable>cout</span><span class= space> </span><span class= delimiter><</span><span class= delimiter><</span><span class= space> </span><span class= string>"SpeedUp reached: " << fixed << setprecision(2) << (oneThread / multiThread) << ".\n"</span><span class= delimiter>;</span><br><br><span class= space>    </span><span class= reserved>delete</span><span class= space> </span><span class= delimiter>[</span><span class= delimiter>]</span><span class= space> </span><span class= variable>arr</span><span class= delimiter>;</span><br><span class= space>    </span><span class= reserved>return</span><span class= space> </span><span class= int>0</span><span class= delimiter>;</span><br><span class= delimiter>}</span><br></body></html>
